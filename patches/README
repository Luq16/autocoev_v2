# Install CAPS, either as dynamic or static binary. Then, install the
# rest of the programs that AutoCoEv drives. Below are instructions for
# Debian/Ubuntu, tested on Ubuntu 20.04 (LTS). For the programs that are
# not available as packages, you may wish to check the corresponding web-
# sites to get the latest versions. Patches are discussed in the bottom.

# These are available as packages:
sudo apt install muscle mafft datamash ncbi-blast+ exonerate prank squizz parallel phyml

# Build Guidance (http://guidance.tau.ac.il/)
sudo apt install bioperl
wget http://guidance.tau.ac.il/guidance.v2.02.tar.gz
tar xvf guidance.v2.02.tar.gz
cd guidance.v2.02
make
cd ..

# I know /usr/local/lib is better, but for now place it here:
sudo cp -a guidance.v2.02 /usr/lib/guidance

# Get Gblocks (http://molevol.cmima.csic.es/castresana/Gblocks.html):
wget http://molevol.cmima.csic.es/castresana/Gblocks/Gblocks_Linux64_0.91b.tar.Z
tar xvf Gblocks_Linux64_0.91b.tar.Z
sudo cp Gblocks_0.91b/Gblocks /usr/local/bin

# Get SeqKit (https://bioinf.shenwei.me/seqkit/)
wget https://github.com/shenwei356/seqkit/releases/download/v2.1.0/seqkit_linux_amd64.tar.gz
tar xvf seqkit_linux_amd64.tar.gz
sudo cp seqkit /usr/local/bin

# Build TreeBeST Ensembl mod (https://github.com/Ensembl/treebest/)
sudo apt install flex bison
wget https://github.com/Ensembl/treebest/archive/347fa82/treebest-347fa82a0ce1c169849053fdc9ff7d19d221f290.tar.gz
tar xvf treebest-347fa82a0ce1c169849053fdc9ff7d19d221f290.tar.gz
cd treebest-347fa82a0ce1c169849053fdc9ff7d19d221f290
make
sudo cp treebest /usr/local/bin

# AutoCoEv uses phyml executable directly, not through the wrapper
# provided by Debian/Ubuntu. Therefore, make a symlink:
cd /usr/local/bin
ln -s ../../lib/phyml/bin/phyml .

# AutoCoEv expects to find MAFFT aliases in your $PATH. Either add
# /usr/lib/mafft/bin to your $PATH or create symlinks, like this:
cd /usr/local/bin
ln -s ../../lib/mafft/mafft-linsi .


## Patches

# 01_caps_verbose.patch
patch for CAPS v2 to produce more verbose output
http://bioinf.gen.tcd.ie/~faresm/software/files/caps2_src.zip

We provide a patch (caps_verbose.patch) to CAPS source code (caps.cpp),
that makes the program output its generated trees, as well as the
p-value for each correlated amino acid pair. For the moment, the patch
introduces these changes only for inter-protein analyses:

CAPS simulates number (-r) of random MSA, where each simulated alignment
has the same number of columns (length) as the real data and is tested
by the same method. This ensures that the data are compared to a null
distribution without coevolution pressures. Correlation information from
the simulated data is stored and sorted into vector totaltemp:

The correlation threshold for each protein pair is based on the
simulated data in totaltemp, found at a certain index, value. It is
determined by the alpha (-a) run-time option, referred here as
threshval:

[1] int value = floor(((totaltemp.size())*(1-(threshval))))+1;

threshold = totaltemp[value];

Correlation between residues R1 and R2 is determined as the mean of
correlation R1→R2 and correlation R2→R1. Each must be higher than the
threshold, whereas thresholdR is always 0.01:

if((fabs(Correl1[cor])>=threshold && fabs(Correl1[cor])>=thresholdR) 
&& (fabs(Correl2[cor])>=threshold && fabs(Correl2[cor])>=thresholdR))

We seek to calculate the p-value of each correlation using the formula
from [1], where value is the correlation closest index within the
totaltemp vector. We introduce a new function getIndex, which ranks a
value K within a vector v, defines its lower bound value as it, then
determines the index of it within the vector. 

Here, v = totaltemp and K = Correl_[cor] and the p-value of Correl_[cor]
is returned as alphathresh:

double getIndex(std::vector<double> const& v, double K) { 
    auto const it = std::lower_bound(v.begin(), v.end(), fabs(K));
      if (it != v.end()) { 
        int index = distance(v.begin(), it);
alphathresh = (((int)1+(double)v.size()-(int)index)/(double)v.size());
return alphathresh;
      } 
      else { 
        cerr << "ELEMENT NOT FOUND!" << endl; 
}
}

We use the index of lower bound it, since an exact match of the
correlation value Correl_[cor] is unlikely to be found within totaltemp:

double Pvalue1 = getIndex(totaltemp, Correl1[cor]);
double Pvalue2 = getIndex(totaltemp, Correl2[cor]);

The patched executable of CAPS is installed as "vCAPS", so it can be
 installed along the the official binary "caps" provided by upstream.


# caps_TreeTemplateTools.patch
patch for bpp-phyl v1.9.0 to work with CAPS2
http://biopp.univ-montp2.fr/repos/sources/bpp-phyl-1.9.0.tar.gz

When phylogenetic trees are not supplied by the user, CAPS generates its
own trees automatically:

tree1 = create_input_tree(vec1.names, vec1.sequences);
tree2 = create_input_tree(vec2.names, vec2.sequences);

Our patch simply outputs the trees by treeToParenthesis:

string temptre1 = TreeTemplateTools::treeToParenthesis(*tree1, true);
string temptre2 = TreeTemplateTools::treeToParenthesis(*tree2, true);
